{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)" />

  {% if debug %}
  <link rel="icon" type="image/svg+xml" href="{% static 'vite-logo.svg' %}" />
  <link rel="apple-touch-icon" href="{% static 'vite-logo.png' %}" />
  {% else %}
  <link rel="icon" type="image/svg+xml" href="/vite-logo.svg" />
  <link rel="apple-touch-icon" href="/vite-logo.png" />
  {% endif %}

  <title>{% block title %}Echo Sphere{% endblock %}</title>
  <meta name="description" content="{% block description %}Echo Sphere{% endblock %}" />
  <meta name="author" content="{% block author %}{% endblock %}" />

  <!-- Open Graph meta tags -->
  <meta property="og:title" content="{% block og_title %}Echo Sphere{% endblock %}" />
  <meta property="og:description" content="{% block og_description %}Echo Sphere{% endblock %}" />
  <meta property="og:type" content="{% block og_type %}website{% endblock %}" />
  <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}" />
  {% block og_image %}{% endblock %}

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@slowpowk" />
  <meta name="twitter:title" content="{% block twitter_title %}Echo Sphere{% endblock %}" />
  <meta name="twitter:description" content="{% block twitter_description %}Echo Sphere{% endblock %}" />
  {% block twitter_image %}{% endblock %}

  <script>
    // Blocking script to set theme before any content renders
    (function () {
      // This script runs before the page renders to prevent flash of unstyled content
      try {
        let theme = "dark"; // Default to dark mode
        let hasSavedPreference = false;

        // Check for saved theme preference first (matches frontend app storage key)
        try {
          const savedTheme = localStorage.getItem("ui-theme");
          if (savedTheme && (savedTheme === "dark" || savedTheme === "light" || savedTheme === "system")) {
            theme = savedTheme;
            hasSavedPreference = true;
          }
        } catch (e) {
          // localStorage not available, continue to system detection
        }

        // If no saved preference, check system preference
        if (!hasSavedPreference) {
          try {
            if (window.matchMedia) {
              if (window.matchMedia("(prefers-color-scheme: light)").matches) {
                theme = "light";
              } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                theme = "dark";
              }
            }
          } catch (e) {
            // matchMedia not available, keep default
          }
        }

        // Apply the theme
        if (theme === "system") {
          const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
          if (systemTheme === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        } else if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        // Add global theme functions
        window.toggleTheme = function () {
          const isDark = document.documentElement.classList.contains("dark");
          if (isDark) {
            document.documentElement.classList.remove("dark");
            localStorage.setItem("ui-theme", "light");
          } else {
            document.documentElement.classList.add("dark");
            localStorage.setItem("ui-theme", "dark");
          }
        };

        window.setTheme = function (theme) {
          localStorage.setItem("ui-theme", theme);

          if (theme === "system") {
            const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
            if (systemTheme === "dark") {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          } else if (theme === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        };

        window.getTheme = function () {
          return localStorage.getItem("ui-theme") || "system";
        };

        window.clearThemePreference = function () {
          localStorage.removeItem("ui-theme");
          const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (systemPrefersDark) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        };

        // Enhanced system theme change detection
        try {
          if (window.matchMedia) {
            const darkModeQuery = window.matchMedia("(prefers-color-scheme: dark)");
            const lightModeQuery = window.matchMedia("(prefers-color-scheme: light)");

            // Function to handle theme changes
            const handleThemeChange = (isDark) => {
              const currentSavedTheme = localStorage.getItem("ui-theme");
              // Only update if no saved preference exists or if system theme is selected
              if (!currentSavedTheme || currentSavedTheme === "system") {
                if (isDark) {
                  document.documentElement.classList.add("dark");
                } else {
                  document.documentElement.classList.remove("dark");
                }
              }
            };

            // Listen for dark mode changes
            darkModeQuery.addEventListener("change", (e) => {
              handleThemeChange(e.matches);
            });

            // Listen for light mode changes (for completeness)
            lightModeQuery.addEventListener("change", (e) => {
              handleThemeChange(!e.matches);
            });

            // Also listen for storage changes (in case theme is changed in another tab)
            window.addEventListener("storage", (e) => {
              if (e.key === "ui-theme") {
                const newTheme = e.newValue;
                if (newTheme === "dark" || newTheme === "light" || newTheme === "system") {
                  if (newTheme === "system") {
                    const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
                    if (systemTheme === "dark") {
                      document.documentElement.classList.add("dark");
                    } else {
                      document.documentElement.classList.remove("dark");
                    }
                  } else if (newTheme === "dark") {
                    document.documentElement.classList.add("dark");
                  } else {
                    document.documentElement.classList.remove("dark");
                  }
                } else {
                  // If theme was cleared, fall back to system preference
                  const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                  handleThemeChange(systemPrefersDark);
                }
              }
            });
          }
        } catch (e) {
          console.error("Error setting up theme change listeners:", e);
        }
      } catch (e) {
        console.error("Error setting theme:", e);
        // Fallback to dark mode on error
        document.documentElement.classList.add("dark");
      }
    })();
  </script>

  <style>
    /* Match frontend app theme system exactly */
    :root {
      --background: 220 100% 98%;
      --foreground: 222.2 84% 4.9%;
      --card: 0 0% 100%;
      --card-foreground: 222.2 84% 4.9%;
      --popover: 0 0% 100%;
      --popover-foreground: 222.2 84% 4.9%;
      --primary: 235 85% 65%;
      --primary-foreground: 210 40% 98%;
      --secondary: 260 50% 60%;
      --secondary-foreground: 222.2 47.4% 11.2%;
      --muted: 210 40% 96.1%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --accent: 250 95% 76%;
      --accent-foreground: 222.2 47.4% 11.2%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 210 40% 98%;
      --border: 214.3 31.8% 91.4%;
      --input: 214.3 31.8% 91.4%;
      --ring: 235 85% 65%;
      --radius: 0.75rem;
      color-scheme: light dark;
    }

    .dark {
      --background: 222.2 84% 4.9%;
      --foreground: 210 40% 98%;
      --card: 222.2 84% 4.9%;
      --card-foreground: 210 40% 98%;
      --popover: 222.2 84% 4.9%;
      --popover-foreground: 210 40% 98%;
      --primary: 235 85% 65%;
      --primary-foreground: 222.2 47.4% 11.2%;
      --secondary: 260 50% 60%;
      --secondary-foreground: 210 40% 98%;
      --muted: 217.2 32.6% 17.5%;
      --muted-foreground: 215 20.2% 65.1%;
      --accent: 250 95% 76%;
      --accent-foreground: 210 40% 98%;
      --destructive: 0 62.8% 30.6%;
      --destructive-foreground: 210 40% 98%;
      --border: 217.2 32.6% 17.5%;
      --input: 217.2 32.6% 17.5%;
      --ring: 235 85% 65%;
      color-scheme: dark;
    }

    /* Base styles using CSS custom properties */
    *,
    ::before,
    ::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
      transition: background-color 0.2s ease, color 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }

    /* Main content */
    .main-content {
      min-height: calc(100vh - 3.5rem);
    }
  </style>

  {% block extra_css %}{% endblock %}
</head>

<body>
  {% include 'shared/header.html' %}

  <main class="main-content">
    {% block content %}{% endblock %}
  </main>

  {% block extra_js %}{% endblock %}

  <!-- Debug panel (only in development) -->
  {% if debug %}
  {% include 'shared/debug_panel.html' %}
  {% endif %}
</body>

</html>
